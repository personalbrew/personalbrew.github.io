---
layout: home
limit: 10
show_excerpts: true
entries_layout: list
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Shop Cart Example</title>
  
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- PayPal SDK (replace YOUR_PAYPAL_CLIENT_ID with your actual client id) -->
  <script src="https://www.paypal.com/sdk/js?client-id=ASvyCegv19q4XcgYlk94h1PTj0kslZMtWN89mTSo2S_XC0PAu5ValW5ngaFHJ7vGinOP12HmDK6be9El&currency=EUR"></script>
  
<style>
    /* Product Grid Styling */
    .product-grid {
      display: flex;
      background-color: #fafafa; /* lighter grey */
      flex-wrap: wrap;
      gap: 20px;
      border-radius: 8px;
      padding: 20px;
    }
    .product-item {
      border: 1px solid #ccc;
      padding: 10px;
      width: 200px;
      text-align: center;
    }
    .product-item img {
      max-width: 100%;
    }
    .price {
      font-size: 1.2em;
      margin: 10px 0;
    }
    .add-to-cart {
      width: 100%;
    }

    /* Cart Container Styling */
    #cart-container {
      margin-top: 40px;
      background-color: #fafafa; /* lighter grey */
      border-radius: 8px;
      padding: 20px;
    }
    #cart-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
	#cart-table tbody tr { 
      border-bottom: none; /* Remove line between products */
    }
    /* Remove outer borders; row separators in medium grey */
    #cart-table th, #cart-table td { border: none; padding: 8px; }
    #cart-table tr { border-bottom: 1px solid #999; }
    #cart-table tr:last-child { border-bottom: none; }
    /* Right align totals */
    #cart-table tfoot td { text-align: right; }
	#cart-table tfoot tr:first-child { 
      border-top: 1px solid #999; /* Add line above subtotal row */
    }
  </style>
</head>
	<body>
	  <h1></h1>
	  
	  <!-- Product Grid (generated from YAML) -->
	  <div class="product-grid">
		{% for product in site.data.products %}
		<div class="product-item" data-id="{{ product.id }}">
		  <a href="{{ product.link }}">
            <img src="{{ product.image }}" alt="{{ product.name }}">
          </a>
		  <h2>{{ product.name }}</h2>
		  <p class="price">{{ product.price | number_format: 2 }} €</p>
		  <!-- Button with data-id; fills container -->
		  <button class="add-to-cart" data-id="{{ product.id }}">Add to cart</button>
		</div>
		{% endfor %}
	  </div>
	  
	  <!-- Cart Container -->
	  <div id="cart-container">
		<h2>Your Cart</h2>
		<small>Free shipping with 3 or more bags</small>
		<div id="cart" style="display: none;">
		  <table id="cart-table">
			<thead>
			  <tr>
				<th>Product</th>
				<th>Quantity</th>
				<th>Price</th>
			  </tr>
			</thead>
			<tbody></tbody>
			<tfoot>
			  <tr>
				<td colspan="3">Subtotal:</td>
				<td id="cart-subtotal"></td>
			  </tr>
			  <tr>
				<td colspan="3">Shipping:</td>
				<td id="cart-shipping"></td>
			  </tr>
			  <tr>
				<td colspan="3">Total:</td>
				<td id="cart-total"></td>
			  </tr>
			</tfoot>
		  </table>
		  <!-- PayPal Button container (initially hidden) -->
		  <div id="paypal-button-container" style="display: none;"></div>
		</div>
	  </div>

	  <script>
		/***** Firebase Initialization *****/
		// Replace these with your Firebase project's configuration values.
				var firebaseConfig = {
	  apiKey: "AIzaSyBhUktdVbhqUYuw5A27fGlBnqeabiPBtyc",
	  authDomain: "personal-brew-webshop.firebaseapp.com",
	  projectId: "personal-brew-webshop",
	  storageBucket: "personal-brew-webshop.firebasestorage.app",
	  messagingSenderId: "861682226406",
	  appId: "1:861682226406:web:c82193e85ffd33c2c75727"
	};
		
		firebase.initializeApp(firebaseConfig);
	  var db = firebase.firestore();

	  /***** Product Class and List from YAML *****/
	  class Product {
		constructor(id, name, price, link, image) {
		  this.id = id;
		  this.name = name;
		  this.price = parseFloat(price);
		  this.link = link;
		  this.image = image;
		}
	  }
	  const products = [];
	  {% for product in site.data.products %}
		products.push(new Product(
		  "{{ product.id }}",
		  "{{ product.name }}",
		  "{{ product.price }}",
		  "{{ product.link }}",
		  "{{ product.image }}"
		));
	  {% endfor %}

	  /***** Cart Variables *****/
	  const cart = {};
	  const shippingCost = 4.00; // Fixed shipping cost

	  /***** Update Cart UI *****/
	  function updateCartUI() {
		const cartTableBody = document.querySelector('#cart-table tbody');
		cartTableBody.innerHTML = '';

		let subtotal = 0;
		let hasItems = false;

		for (const id in cart) {
		  const item = cart[id];
		  hasItems = true;

		  const row = document.createElement('tr');
		  row.innerHTML =
			'<td>' + item.product.name + '</td>' +
			'<td>' +
			  '<button class="qty-btn" onclick="updateQuantity(\'' + id + '\', -1)">-</button>' +
			  '<span class="quantity">' + item.quantity + '</span>' +
			  '<button class="qty-btn" onclick="updateQuantity(\'' + id + '\', 1)">+</button>' +
			'</td>' +
			'<td>' + (item.product.price * item.quantity).toFixed(2) + " €" + '</td>';
		  
		  cartTableBody.appendChild(row);
		  subtotal += item.product.price * item.quantity;
		}

		document.getElementById('cart-subtotal').textContent = subtotal.toFixed(2) + " €";
		document.getElementById('cart-shipping').textContent = shippingCost.toFixed(2) + " €";
		document.getElementById('cart-total').textContent = (subtotal + shippingCost).toFixed(2) + " €";

		// Show cart only if there are items
		document.getElementById('cart').style.display = hasItems ? 'block' : 'none';
		document.getElementById('paypal-button-container').style.display = hasItems ? 'block' : 'none';
	  }

	  /***** Update Quantity with Plus/Minus Buttons *****/
	  function updateQuantity(productId, change) {
		if (cart[productId]) {
		  const newQuantity = cart[productId].quantity + change;
		  if (newQuantity > 0) {
			cart[productId].quantity = newQuantity;
		  } else {
			delete cart[productId]; // Remove product if quantity is 0
		  }
		  updateCartUI();
		}
	  }

	  /***** Add to Cart with Inventory Check *****/
	  function addToCart(productId) {
		var productRef = db.collection('inventory').doc(productId);
		productRef.get().then(function(doc) {
		  if (doc.exists) {
			const currentStock = doc.data().stock;
			const currentQuantity = cart[productId] ? cart[productId].quantity : 0;

			if (currentQuantity < currentStock) {
			  const product = products.find(p => p.id === productId);
			  if (!product) return;

			  if (cart[productId]) {
				cart[productId].quantity++;
			  } else {
				cart[productId] = { product: product, quantity: 1 };
			  }
			  updateCartUI();
			} else {
			  alert("Sorry, no more stock available for this product.");
			}
		  } else {
			console.error("Product " + productId + " not found in inventory.");
		  }
		}).catch(function(error) {
		  console.error("Error fetching product stock:", error);
		});
	  }

	  document.querySelectorAll('.add-to-cart').forEach(function(button) {
		button.addEventListener('click', function() {
		  addToCart(this.getAttribute('data-id'));
		});
	  });

	  /***** Checkout: Inventory Update & PayPal Integration *****/
	  function checkoutInventory() {
		const promises = [];
		for (const id in cart) {
		  promises.push(processCartItem(id, cart[id].quantity));
		}
		return Promise.all(promises);
	  }

	  function processCartItem(productId, quantity) {
		var productRef = db.collection('inventory').doc(productId);
		return db.runTransaction(function(transaction) {
		  return transaction.get(productRef).then(function(doc) {
			if (!doc.exists) {
			  throw 'Product ' + productId + ' does not exist.';
			}
			const stock = doc.data().stock;
			if (stock < quantity) {
			  throw 'Not enough stock for ' + productId + '. Available: ' + stock;
			}
			transaction.update(productRef, { stock: stock - quantity });
		  });
		});
	  }

	  // Render PayPal button
	  paypal.Buttons({
		createOrder: function(data, actions) {
		  const subtotal = Object.keys(cart).reduce((sum, id) => sum + cart[id].product.price * cart[id].quantity, 0);
		  const total = subtotal + shippingCost;
		  return actions.order.create({
			purchase_units: [{
			  amount: {
				currency_code: "EUR",
				value: total.toFixed(2)
			  }
			}]
		  });
		},
		onApprove: function(data, actions) {
		  return actions.order.capture().then(function(details) {
			checkoutInventory().then(function() {
			  alert("Transaction completed by " + details.payer.name.given_name);
			  for (const id in cart) { delete cart[id]; }
			  updateCartUI();
			}).catch(function(error) {
			  console.error("Inventory update error:", error);
			  alert("Payment succeeded, but inventory update failed: " + error);
			});
		  });
		},
		onError: function(err) {
		  console.error("PayPal error:", err);
		  alert("Payment error: " + err);
		}
	  }).render('#paypal-button-container');

	  updateCartUI();
	</script>
	</body>
</html>