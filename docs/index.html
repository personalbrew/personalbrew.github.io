---
layout: home
limit: 10
show_excerpts: true
entries_layout: list
permalink: /
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Shop Cart Example</title>
  
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Firebase config -->
  <script src="/scripts/firebase-config.js"></script>
  <script src="/scripts/shopping_cart.js"></script>
  
  <!-- PayPal SDK (replace YOUR_PAYPAL_CLIENT_ID with your actual client id) -->
  <script src="https://www.paypal.com/sdk/js?client-id=ASvyCegv19q4XcgYlk94h1PTj0kslZMtWN89mTSo2S_XC0PAu5ValW5ngaFHJ7vGinOP12HmDK6be9El&currency=EUR"></script>
    
  <style>
    /* Product Grid Styling */
    .product-grid {
      display: flex;
      background-color: #fafafa; /* lighter grey */
      flex-wrap: wrap;
      gap: 10px;
      border-radius: 8px;
      padding: 20px;
    }
    .product-item {
      border: 1px solid #ccc;
      padding: 10px;
      width: 200px;
      text-align: center;
      position: relative;
    }
    @media (max-width: 800px) {
    .product-item {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      position: relative;
    /* Show two items per row with a little gap */
    width: calc(50% - 10px);
  }
}

    .product-item img {
      max-width: 100%;
    }
    .name {
      font-size: 1.0em;
      font-weight: bold;
      margin: 10px 0;
    }
    .weight {
      font-size: 0.85em;
      margin: 0px 10px;
      text-align: right;
    }
    .price {
      font-size: 0.9em;
      margin: 0px 10px;
      text-align: left;
    }
    .add-to-cart {
      width: 100%;
      padding: 8px;
      cursor: pointer;
    }
    .add-to-cart:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* Cart Container Styling */
    #cart-container {
      margin-top: 40px;
      background-color: #fafafa; /* lighter grey */
      border-radius: 8px;
      padding: 20px;
    }
    #cart-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    #cart-table th, #cart-table td { 
      border: none; 
      padding: 8px; 
    }
    #cart-table tr { 
      border: none; 
    }
    #cart-table tfoot tr { 
      border-top: 1px solid #999; 
    }
    /* Right align totals */
    #cart-table tfoot td { 
      text-align: right; 
    }
    #coupon-container {
      margin: 20px 0;
    }
    #coupon-container input {
      padding: 4px;
      margin-left: 8px;
    }
    #coupon-container button {
      padding: 4px 8px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h1></h1>
  
  <!-- Product Grid (generated from YAML) -->
  <div class="product-grid">
    {% for product in site.data.products %}
    <div class="product-item" data-id="{{ product.id }}">
      <a href="products/{{ product.unique-name }}">
        <img src="products/{{ product.unique-name }}/image0.jpg" alt="{{ product.name }}">
      </a>
      <p class="name">{{ product.name }}</p>
      <p class="weight">{{ product.grammage }} g</p>
      <p class="price" style="text-align:left; font-size: 0.95em;">
        <script>
          var price = Number({{ product.price }});
          document.write(price.toFixed(2));
        </script> €
        <span style="float:right;font-size:0.85em;">(
        <script> 
          document.write({{product.price}}*1000/{{ product.grammage }}); 
        </script>
         €/kg)
        </span>
      </p>
      <!-- Button with data-id; will be disabled when out of stock -->
      <button class="add-to-cart" data-id="{{ product.id }}">Add to cart</button>
    </div>
    {% endfor %}
  </div>
  
  <!-- Cart Container -->
  <div id="cart-container">
    <h2>Your Cart</h2>
	<!--
    <small>Free shipping with 3 or more bags</small>
	 -->
    <div id="cart" style="display: none;">
      <table id="cart-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Unit price</th>
            <th>Line total</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="4">Subtotal:</td>
            <td id="cart-subtotal"></td>
          </tr>
          <tr>
            <!-- Shipping row now includes a dropdown to select shipping country -->
            <td colspan="4">
              Shipping 
              <select id="shipping-country">
                <option value="Germany">Germany</option>
                <option value="EU">EU-wide</option>
              </select>
              :
            </td>
            <td id="cart-shipping"></td>
          </tr>
        </tfoot>
      </table>
      
      <!-- Coupon Code Section -->
      <div id="coupon-container">
        <label for="coupon-code">Coupon:</label>
        <input type="text" id="coupon-code">
        <button id="apply-coupon">Apply</button>
        <span id="coupon-message"></span>
      </div>
      
      <!-- PayPal Button container (initially hidden) -->
      <div id="paypal-button-container" style="display: none;"></div>
    </div>
  </div>
  
  <script>

    var appliedCoupon = null;
    


    // Load shipping costs from YAML
    var shippingCosts = {
      "Germany": {{ site.data.shipping_cost.Germany | jsonify }},
      "EU": {{ site.data.shipping_cost.EU | jsonify }}
    };

    /***** Product Class and List from YAML *****/
    class Product {
      constructor(id, name, price) {
        this.id = id;
        this.name = name;
      }
    }
    const products = [];
    {% for product in site.data.products %}
      products.push(new Product(
        "{{ product.id }}",
        "{{ product.name }}"
      ));
    {% endfor %}

    
    // Bind event listeners to all add-to-cart buttons
    document.querySelectorAll('.add-to-cart').forEach(function(button) {
      button.addEventListener('click', function() {
        addToCart(this.getAttribute('data-id'));
      });
    });


/* ====================
   Coupon Code Application
   ==================== */
   document.getElementById('apply-coupon').addEventListener('click', function() {
  var code = document.getElementById('coupon-code').value.trim();
  if (!code) {
    document.getElementById('coupon-message').textContent = "Please enter a coupon code.";
    return;
  }
  var couponRef = db.collection('coupons').doc(code);
  couponRef.get().then(function(doc) {
    if (doc.exists) {
      appliedCoupon = { code: code, action: doc.data().action };
      document.getElementById('coupon-message').textContent = "Applied";
    } else {
      appliedCoupon = null;
      document.getElementById('coupon-message').textContent = "Invalid";
    }
    updateCartUI();
  }).catch(function(error) {
    console.error("Error fetching coupon:", error);
    document.getElementById('coupon-message').textContent = "Error checking coupon.";
  });
});



// PayPal Button Integration
paypal.Buttons({
  createOrder: function(data, actions) {
    var totals = computeTotals();
    return actions.order.create({
      purchase_units: [{
        amount: {
          currency_code: "EUR",
          value: totals.finalTotal.toFixed(2)
        }
      }]
    });
  },
  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
      checkoutInventory().then(function() {
        alert("Transaction completed by " + details.payer.name.given_name);
        // Clear cart after successful checkout
        saveCart({});
        updateCartUI();
      }).catch(function(error) {
        console.error("Inventory update error:", error);
        alert("Payment succeeded, but inventory update failed: " + error);
      });
    });
  },
  onError: function(err) {
    console.error("PayPal error:", err);
    alert("Payment error: " + err);
  }
}).render('#paypal-button-container');

   document.getElementById('shipping-country').addEventListener('change', updateCartUI);

    // Initial UI update
    updateCartUI();

    function updateCartUI() {
      var cartTableBody = document.querySelector('#cart-table tbody');
      cartTableBody.innerHTML = '';
      var cart = getCart();
      
      // Render cart items and compute subtotal
      for (const id in cart) {
        const item = cart[id];
        const product = products.find(p => p.id === item.product);
        const row = document.createElement('tr');
        row.innerHTML =
          '<td>' + product.name + '</td>' +
          '<td>' +
            '<button class="qty-btn" onclick="updateQuantity(\'' + id + '\', -1)">-</button>' +
            '<span class="quantity">' + item.quantity + '</span>' +
            '<button class="qty-btn" onclick="updateQuantity(\'' + id + '\', 1)">+</button>' +
          '</td>' +
          '<td>' + item.price + " €" + '</td>' +
          '<td>' + (item.price * item.quantity).toFixed(2) + " €" + '</td>';

        cartTableBody.appendChild(row);
      }
      
      // Compute totals using our helper
      var totals = computeTotals();
      var tfoot = document.querySelector('#cart-table tfoot');
      var totalsHTML = `
        <tr>
          <td colspan="3">Subtotal:</td>
          <td id="cart-subtotal">${totals.subtotal.toFixed(2)} €</td>
        </tr>
        <tr>
          <td colspan="3">
            Shipping 
            <select id="shipping-country">
              <option value="Germany"${totals.selectedCountry === "Germany" ? " selected" : ""}>Germany</option>
              <option value="EU"${totals.selectedCountry === "EU" ? " selected" : ""}>EU-wide</option>
            </select>:
          </td>
          <td id="cart-shipping">${totals.shippingCost.toFixed(2)} €</td>
        </tr>
        ${ appliedCoupon && totals.couponDiscount > 0
            ? `<tr id="row-coupon"><td colspan="3">Coupon Discount:</td><td>${totals.couponLineText}</td></tr>`
            : ""
        }
        <tr id="row-total">
          <td colspan="3">Total:</td>
          <td>${totals.finalTotal.toFixed(2)} €</td>
        </tr>
      `;
      tfoot.innerHTML = totalsHTML;
      
      // Reattach event listener for shipping dropdown since it is re-created
      document.getElementById('shipping-country').addEventListener('change', updateCartUI);
      
      // Show or hide cart container and PayPal button
      var hasItems = Object.keys(cart).length > 0;
      document.getElementById('cart').style.display = hasItems ? 'block' : 'none';
      document.getElementById('paypal-button-container').style.display = hasItems ? 'block' : 'none';
      
      updateAddToCartButtons();
    }

    document.addEventListener("DOMContentLoaded", function() {
      updateCartUI();
    });
  </script>
</body>
</html>
